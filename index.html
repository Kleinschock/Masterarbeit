<!DOCTYPE html>
<html>
<head>
    <title>Musik & immersive Welten Studie</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css">
    <style>
        body { font-family: Arial, Helvetica, sans-serif; line-height: 1.6; }
        .jspsych-display-element { font-size: 16px; }
        .jspsych-content { max-width: 800px; margin: auto; padding-bottom: 50px; /* Platz für den letzten Button */ }
        .survey-section-title {
            font-size: 1.5em; font-weight: bold; margin-top: 30px;
            margin-bottom: 20px; text-align: center;
            border-bottom: 1px solid #ccc; padding-bottom: 10px;
        }
        .jspsych-survey-html-form-question,
        .jspsych-survey-likert-statement {
            margin-bottom: 2.5em; text-align: left;
        }
        .jspsych-survey-html-form-question label, /* Gilt auch für Radio-Button-Labels im HTML-Formular */
        .jspsych-survey-likert-opts label { /* Gilt für Likert-Plugin-Labels */
            margin-right: 1em;
            font-weight: normal;
            display: block; /* Stellt sicher, dass jedes Label eine neue Zeile beginnt, falls im HTML so gewollt */
            margin-bottom: 8px; /* Abstand zwischen Radio-Optionen */
        }
        .radio-horizontal label { display: inline-block; margin-bottom: 0;}

        .survey-preamble {
            max-width: 750px; margin-left: auto; margin-right: auto; margin-bottom: 25px;
            padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;
            text-align: left; border-radius: 5px;
        }
        .question-text { font-weight: bold; margin-bottom: 10px; display: block; }
        .jspsych-survey-html-form-question input[type="radio"],
        .jspsych-survey-html-form-question input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        .jspsych-instructions-nav { margin-top: 20px; }
        .jspsych-btn { margin: 10px 5px; padding: 10px 20px; font-size: 1em; }

        .researcher-input-form div { margin-bottom: 15px; text-align: left; }
        .researcher-input-form label {
            display: inline-block; width: 250px; margin-right: 10px; font-weight: bold;
            vertical-align: middle;
        }
        .researcher-input-form input[type="text"],
        .researcher-input-form select {
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 280px;
            vertical-align: middle;
        }
        textarea, input[type="text"].free-text-instrument { /* Styling für offene Textfelder */
            width: 100%; min-height: 40px; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; box-sizing: border-box; margin-top: 5px;
        }
        .jspsych-survey-html-form- grubu {
            padding-left: 15px;
        }
    </style>
</head>
<body>
</body>
<script>

    let researcher_data = {};

    function objectToCsv(dataObject) {
        const header = Object.keys(dataObject).join(',');
        const values = Object.values(dataObject).map(val => {
            if (typeof val === 'string' && (val.includes(',') || val.includes('\n') || val.includes('"'))) {
                return `"${val.replace(/"/g, '""')}"`;
            }
            return val;
        }).join(',');
        return header + '\n' + values;
    }

    function downloadTextAsFile(filename, text) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    const jsPsych = initJsPsych({
        on_finish: function(data) {
            const default_filename = `data_long_VP_${researcher_data.subject_id}_${researcher_data.condition_between}_Gruppe${researcher_data.condition_within_group}.csv`;
            jsPsych.data.get().localSave('csv', default_filename);

            const wideData = createWideFormatData(jsPsych.data.get());
            if (wideData) {
                const wide_csv_string = objectToCsv(wideData);
                const wide_filename = `data_wide_VP_${researcher_data.subject_id}_${researcher_data.condition_between}_Gruppe${researcher_data.condition_within_group}.csv`;
                downloadTextAsFile(wide_filename, wide_csv_string);
            }
            console.log("Experiment beendet. Daten wurden gespeichert.");
            document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 20px; text-align: center;">Vielen Dank! Ihre Daten wurden gespeichert.<br>Sie können dieses Fenster nun schließen.</div>`;
        },
        on_data_update: function(data_row) {
            data_row.subject_id = researcher_data.subject_id;
            data_row.condition_between = researcher_data.condition_between;
            data_row.condition_within_group = researcher_data.condition_within_group;
        }
    });

    function createWideFormatData(jspsych_data_collection) {
        const wide_data_object = {};
        wide_data_object.subject_id = researcher_data.subject_id;
        wide_data_object.condition_between = researcher_data.condition_between;
        wide_data_object.condition_within_group = researcher_data.condition_within_group;

        const phase1_data = jspsych_data_collection.filter({task: 'phase1_demographics_experience'}).trials[0];
        if (phase1_data && phase1_data.response) {
            for (const [key, value] of Object.entries(phase1_data.response)) { wide_data_object[key] = value; }
        }
        const phase3_music_feedback = jspsych_data_collection.filter({task: 'phase3_music_feedback'}).trials[0];
        if (phase3_music_feedback && phase3_music_feedback.response) {
            for (const [key, value] of Object.entries(phase3_music_feedback.response)) { wide_data_object[key] = value; }
        }

        // Gold-MSI Daten (AE, MT, EM)
        ['ActiveEngagement', 'MusicalTraining', 'Emotions'].forEach(subscale => {
            const trial_data = jspsych_data_collection.filter({task: 'gold-msi', subscale: subscale}).trials[0];
            if (trial_data && trial_data.response) {
                for (const [key, value] of Object.entries(trial_data.response)) { wide_data_object[key] = value; }
            }
        });
        // Gold-MSI Zusatzfragen
        const gold_msi_extra_trial = jspsych_data_collection.filter({task: 'gold-msi-extra-questions'}).trials[0];
        if (gold_msi_extra_trial && gold_msi_extra_trial.response) {
            for (const [key, value] of Object.entries(gold_msi_extra_trial.response)) { wide_data_object[key] = value; }
        }


        const aims_trial = jspsych_data_collection.filter({task: 'aims'}).trials[0];
        if (aims_trial && aims_trial.response) {
            const original_aims_item_names = aimsItems_german_with_labels.map(item => item.name);
            for (const itemName of original_aims_item_names) {
                wide_data_object[itemName] = aims_trial.response.hasOwnProperty(itemName) ? aims_trial.response[itemName] : '';
            }
        }
        const phase3_tech_comfort = jspsych_data_collection.filter({task: 'phase3_tech_comfort'}).trials[0];
        if (phase3_tech_comfort && phase3_tech_comfort.response) {
            for (const [key, value] of Object.entries(phase3_tech_comfort.response)) { wide_data_object[key] = value; }
        }
        const phase3_active_feedback = jspsych_data_collection.filter({task: 'phase3_active_feedback'}).trials[0];
        if (phase3_active_feedback && phase3_active_feedback.response) {
            for (const [key, value] of Object.entries(phase3_active_feedback.response)) { wide_data_object[key] = value; }
        }
        return wide_data_object;
    }

    const researcher_input_trial = {
        type: jsPsychSurveyHtmlForm,
        preamble: `<div style="text-align:center; margin-bottom:20px;"><h2>Einstellungen für den Versuchsdurchlauf</h2><p>Bitte geben Sie die folgenden Informationen ein:</p></div>`,
        html: `<div class="researcher-input-form"><div><label for="subject_id">Subject ID:</label><input type="text" id="subject_id" name="subject_id" required placeholder="z.B. VP001"></div><div><label for="condition_between">Between Subject (Technologie):</label><select id="condition_between" name="condition_between" required><option value="">-- Bitte wählen --</option><option value="AR">AR (Augmented Reality)</option><option value="VR">VR (Virtual Reality)</option></select></div><div><label for="condition_within_group">Within Randomisation Group:</label><select id="condition_within_group" name="condition_within_group" required><option value="">-- Bitte wählen --</option><option value="A">Gruppe A (Control -> No interaction -> Interaction)</option><option value="B">Gruppe B (Control -> Interaction -> No interaction)</option></select></div></div>`,
        button_label: 'Experiment starten',
        on_finish: function(data) {
            researcher_data = {
                subject_id: data.response.subject_id,
                condition_between: data.response.condition_between,
                condition_within_group: data.response.condition_within_group
            };
        }
    };

    const phase1_instructions = {
        type: jsPsychInstructions,
        pages: [
            `<div class='survey-section-title'>Fragebogen: Teil 1</div><p style="text-align:center;">Willkommen zur Studie! Bitte beantworten Sie zunächst einige allgemeine Fragen zu Ihrer Person und Ihren Vorerfahrungen.</p>`
        ],
        show_clickable_nav: true, button_label_next: "Weiter", data: {task: "phase1_intro"}
    };

    function createRadioGroup(name, questionText, options) {
        let html = `<div class="jspsych-survey-html-form-question"><p class="question-text">${questionText}</p><div class="jspsych-survey-html-form- grubu">`;
        options.forEach(opt => {
            html += `<label><input type="radio" name="${name}" value="${opt.value}" required> ${opt.label}</label>`;
        });
        html += `</div></div>`;
        return html;
    }

    const phase1_demographics_experience_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase1_demographics_experience' },
        preamble: `<div class='survey-section-title'>Abschnitt A: Demographische Angaben & Abschnitt B: Erfahrung mit VR/AR</div>`,
        html: `
            <div class="jspsych-survey-html-form-question">
                <p class="question-text">Bitte geben Sie Ihr Alter an (in Jahren):</p>
                <input type="number" name="P1_alter" required min="1" style="width:100px; padding:8px;">
            </div>
            ${createRadioGroup("P1_geschlecht", "Bitte geben Sie Ihr Geschlecht an:", [
                {value: "maennlich", label: "männlich"}, {value: "weiblich", label: "weiblich"},
                {value: "divers", label: "divers"}, {value: "keine_angabe", label: "keine Angabe"}
            ])}
            ${createRadioGroup("P1_sehvermoegen", "Haben Sie normales oder auf normal korrigiertes Sehvermögen?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            ${createRadioGroup("P1_hoervermoegen", "Haben Sie normales oder auf normal korrigiertes Hörvermögen?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            <hr style="margin: 30px 0;">
            ${createRadioGroup("P1_erfahrung_vr", "Wie würden Sie Ihre bisherige Erfahrung mit Virtual Reality (VR) einschätzen?", [
                {value: "1", label: "1 (Gar keine Erfahrung)"}, {value: "2", label: "2 (Sehr wenig Erfahrung)"},
                {value: "3", label: "3 (Wenig Erfahrung)"}, {value: "4", label: "4 (Mittelmäßige Erfahrung)"},
                {value: "5", label: "5 (Deutliche Erfahrung)"}, {value: "6", label: "6 (Viel Erfahrung)"},
                {value: "7", label: "7 (Sehr viel Erfahrung / Experte/Expertin)"}
            ])}
            ${createRadioGroup("P1_erfahrung_ar", "Wie würden Sie Ihre bisherige Erfahrung mit Augmented Reality (AR) einschätzen?", [
                {value: "1", label: "1 (Gar keine Erfahrung)"}, {value: "2", label: "2 (Sehr wenig Erfahrung)"},
                {value: "3", label: "3 (Wenig Erfahrung)"}, {value: "4", label: "4 (Mittelmäßige Erfahrung)"},
                {value: "5", label: "5 (Deutliche Erfahrung)"}, {value: "6", label: "6 (Viel Erfahrung)"},
                {value: "7", label: "7 (Sehr viel Erfahrung / Experte/Expertin)"}
            ])}
            ${createRadioGroup("P1_nutzung_vr_12m", "Wie häufig haben Sie in den letzten 12 Monaten Virtual Reality (VR) genutzt?", [
                {value: "nie", label: "Nie"}, {value: "seltener_1m", label: "Weniger als einmal im Monat"},
                {value: "ca_1m", label: "Etwa einmal im Monat"}, {value: "mehrmals_m", label: "Mehrmals im Monat"},
                {value: "ca_1w", label: "Etwa einmal pro Woche"}, {value: "mehrmals_w", label: "Mehrmals pro Woche"},
                {value: "taeglich", label: "Täglich"}
            ])}
            ${createRadioGroup("P1_nutzung_ar_12m", "Wie häufig haben Sie in den letzten 12 Monaten Augmented Reality (AR) genutzt?", [
                {value: "nie", label: "Nie"}, {value: "seltener_1m", label: "Weniger als einmal im Monat"},
                {value: "ca_1m", label: "Etwa einmal im Monat"}, {value: "mehrmals_m", label: "Mehrmals im Monat"},
                {value: "ca_1w", label: "Etwa einmal pro Woche"}, {value: "mehrmals_w", label: "Mehrmals pro Woche"},
                {value: "taeglich", label: "Täglich"}
            ])}
        `,
        button_label: "Weiter zur Instruktion für das Experiment"
    };

    const phase2_experiment_instructions = {
        type: jsPsychInstructions,
        pages: function(){
            const tech = researcher_data.condition_between === "AR" ? "Augmented Reality (AR)" :
                         researcher_data.condition_between === "VR" ? "Virtual Reality (VR)" :
                         "Headset";
            return [
                `<div class='survey-section-title'>Experimentelle Durchführung</div>
                 <p style="text-align:center;">Vielen Dank für das Ausfüllen des ersten Fragebogenteils.</p>
                 <p style="text-align:center;">Das eigentliche Experiment im ${tech} wird nun außerhalb dieses Programms durchgeführt.</p>
                 <p style="text-align:center;">Bitte informieren Sie den Versuchsleiter, dass Sie bereit sind.</p>
                 <p style="text-align:center;">Nach Abschluss des Experiments im ${tech} werden Sie gebeten, hier mit dem letzten Fragebogenteil fortzufahren.</p>`
            ];
        },
        show_clickable_nav: true,
        button_label_next: "Ich habe das Experiment im Headset abgeschlossen und möchte fortfahren",
        data: {task: "phase2_instructions"}
    };

    const phase3_instructions = {
        type: jsPsychInstructions,
        pages: [
            `<div class='survey-section-title'>Abschlussfragebögen: Teil 2</div><p style="text-align:center;">Willkommen zurück! Bitte beantworten Sie nun die letzten Fragebögen.</p>`
        ],
        show_clickable_nav: true, button_label_next: "Weiter", data: {task: "phase3_intro"}
    };

    const phase3_music_feedback_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase3_music_feedback' },
        preamble: `<div class='survey-section-title'>Abschnitt C: Feedback zum Musikstück</div>`,
        html: function() {
            return `
                ${createRadioGroup("P3_C1_musik_bekannt", "Kannten Sie das Musikstück ('Hedwig's Theme'), das während des Experiments gespielt wurde, bereits vorher?", [
                    {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
                ], true)}

                ${createRadioGroup("P3_C2_genre_filmmusik_like", "Wie sehr mögen Sie das Genre 'Filmmusik' im Allgemeinen?", [
                    {value: "1", label: "1 (Mag ich überhaupt nicht)"}, {value: "2", label: "2"}, {value: "3", label: "3"},
                    {value: "4", label: "4 (Neutral)"}, {value: "5", label: "5"}, {value: "6", label: "6"},
                    {value: "7", label: "7 (Mag ich sehr)"}
                ], true)}

                <div class="jspsych-survey-html-form-question">
                    <p class="question-text">Wie sehr mögen Sie das spezifische Musikstück 'Hedwig's Theme'?</p>
                    <div class="jspsych-survey-html-form- grubu">
                        <select name="P3_C3_hedwig_like" id="P3_C3_hedwig_like" required style="padding:8px; width:auto;">
                            <option value="">-- Bitte wählen --</option>
                            <option value="1">1 (Mag ich überhaupt nicht)</option> <option value="2">2</option> <option value="3">3</option>
                            <option value="4">4 (Neutral)</option> <option value="5">5</option> <option value="6">6</option>
                            <option value="7">7 (Mag ich sehr)</option>
                            <option value="kann_nicht_beurteilen">Kann ich nicht beurteilen, da unbekannt</option>
                        </select>
                    </div>
                </div>
            `;
        },
        on_load: function() {
            const radio_c1_nein = document.querySelector('input[name="P3_C1_musik_bekannt"][value="nein"]');
            const radio_c1_ja = document.querySelector('input[name="P3_C1_musik_bekannt"][value="ja"]');
            const select_c3 = document.getElementById('P3_C3_hedwig_like');

            function updateC3Status() {
                const c1_nein_checked = radio_c1_nein && radio_c1_nein.checked;
                const c1_ja_checked = radio_c1_ja && radio_c1_ja.checked;

                if (c1_nein_checked) {
                    select_c3.value = 'kann_nicht_beurteilen';
                    // select_c3.disabled = true; // Wenn Sie es ausgrauen wollen
                } else if (c1_ja_checked) {
                    // select_c3.disabled = false;
                    if (select_c3.value === 'kann_nicht_beurteilen') {
                         select_c3.value = "";
                    }
                } else { // Initialer Zustand oder wenn keine C1-Antwort
                    // select_c3.disabled = false;
                }
            }

            if (radio_c1_ja) radio_c1_ja.addEventListener('change', updateC3Status);
            if (radio_c1_nein) radio_c1_nein.addEventListener('change', updateC3Status);
            updateC3Status();
        },
        button_label: "Weiter"
    };

    // --- Gold-MSI Items (AE, MT, EM) ---
    const goldMsiItems_All = [
        // Active Engagement (AE)
        { mid: "AE_01", item: "Ich beschäftige mich in meiner Freizeit viel mit musikbezogenen Aktivitäten.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_02", item: "Ich schreibe gerne über Musik, z. B. in Internetblogs oder Foren.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_03", item: "Ich bin fasziniert von Musikstilen, mit denen ich nicht vertraut bin, und möchte mehr darüber erfahren.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_04", item: "Ich habe ____ Live-Events als Zuschauer innerhalb der letzten 12 Monate besucht.", response_type: "categorical", options: ["0", "1", "2", "3", "4-6", "7-10", "11 oder mehr"], negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_05", item: "Ich lese oder suche oft im Internet nach Dingen, die mit Musik zu tun haben.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_06", item: "Ich gebe nicht viel Geld meines verfügbaren Einkommens für Musik aus.", response_type: "likert7", negative: true, subscale: "ActiveEngagement" },
        { mid: "AE_07", item: "Musik ist für mich eine Art von Sucht – ohne sie könnte ich nicht leben.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_08", item: "Ich höre jeden Tag aufmerksam Musik für ____.", response_type: "categorical", options: ["0-15min", "15-30min", "30-60min", "60-90min", "2 Std", "2-3 Std", "4 Std oder mehr"], negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_09", item: "Ich halte mich auf dem Laufenden, was neue Musik angeht (z. B. neue Künstler oder Aufnahmen).", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },

        // Musical Training (MT)
        { mid: "MT_01", item: "Ich habe regelmäßig und täglich ein Instrument (einschließlich Gesang) für ____ Jahre geübt.", response_type: "categorical", options: ["0", "1", "2", "3", "4-5", "6-9", "10 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_02", item: "An dem Höhepunkt meines Interesses habe ich mein Hauptinstrument ____ Stunden pro Tag geübt.", response_type: "categorical", options: ["0", "0,5", "1", "1,5", "2", "3-4", "5 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_03", item: "Ich bin noch nie für meine musikalischen Fähigkeiten gelobt worden.", response_type: "likert7", negative: true, subscale: "MusicalTraining" },
        { mid: "MT_04", item: "Ich habe ____ Jahre Unterricht in Musiktheorie (außerhalb der Schule) erhalten.", response_type: "categorical", options: ["0", "0,5", "1", "2", "3", "4-6", "7 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_05", item: "Ich habe ____ Jahre Musikunterricht auf einem Instrument (einschließlich Gesang) in meinem bisherigen Leben gehabt.", response_type: "categorical", options: ["0", "1", "2", "3", "4-5", "6-9", "10 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_06", item: "Ich kann ____ verschiedene Instrumente spielen.", response_type: "categorical", options: ["0", "1", "2", "3", "4", "5", "6 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_07", item: "Ich würde mich selbst nicht als Musiker/-in bezeichnen.", response_type: "likert7", negative: true, subscale: "MusicalTraining" },

        // Emotions (EM)
        { mid: "EM_01", item: "Ich suche oft Musik aus, bei der ich eine Gänsehaut bekomme.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_02", item: "Musikstücke rufen selten Gefühle in mir hervor.", response_type: "likert7", negative: true, subscale: "Emotions" },
        { mid: "EM_03", item: "Ich suche häufig eine bestimmte Musik aus, um mich zu motivieren oder zu begeistern.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_04", item: "Ich kann identifizieren, was das Besondere an einem bestimmten Musikstück ist.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_05", item: "Ich bin in der Lage, über meine Gefühle, die durch Musik hervorgerufen werden, zu sprechen.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_06", item: "Musik kann bei mir Erinnerungen an Personen und Orte hervorrufen.", response_type: "likert7", negative: false, subscale: "Emotions" },
    ];

    function createGoldMsiSurveyQuestionHTML(question) {
        let html = `<span class="question-text">${question.item.replace(/____/g, '___')}</span><div class="jspsych-survey-html-form- grubu">`;
        if (question.response_type === "likert7") {
            for (let i = 1; i <= 7; i++) {
                html += `<label><input type="radio" name="${question.mid}" value="${i}" required> ${i}</label>`;
            }
        } else if (question.response_type === "categorical") {
            question.options.forEach((option) => {
                html += `<label><input type="radio" name="${question.mid}" value="${option.replace(',', '.')}" required> ${option}</label>`;
            });
        }
        html += `</div>`; return html;
    }

    const goldMsi_instructions_trial_phase3 = {
        type: jsPsychInstructions, pages: [ `<div class='survey-section-title'>Abschnitt D: Musikalische Vorerfahrung und Absorption</div><p style="text-align:center;">Es folgen nun Fragebögen zu Ihrer allgemeinen musikalischen Erfahrung.</p>` ],
        show_clickable_nav: true, button_label_next: "Weiter", data: {task: "goldmsi_aims_intro_p3"}
    };
    const goldMsi_likert_preamble_html = `<div class='survey-preamble'><strong>Gold-MSI Skala:</strong><br>1 = Stimme ganz und gar nicht zu; 2 = Stimme nicht zu; 3 = Stimme eher nicht zu; 4 = Weder noch; 5 = Stimme eher zu; 6 = Stimme zu; 7 = Stimme voll und ganz zu</div>`;

    function createGoldMsiSurveyTrial(subscaleName, items, preamble = null) {
        const survey_questions_html = items.filter(q => q.subscale === subscaleName).map(q => `<div class="jspsych-survey-html-form-question">${createGoldMsiSurveyQuestionHTML(q)}</div>`).join('');
        return { type: jsPsychSurveyHtmlForm, preamble: preamble, html: survey_questions_html, button_label: "Weiter", data: { task: 'gold-msi', subscale: subscaleName } };
    }
    const goldMsi_ae_survey_trial = createGoldMsiSurveyTrial("ActiveEngagement", goldMsiItems_All, goldMsi_likert_preamble_html);
    const goldMsi_mt_survey_trial = createGoldMsiSurveyTrial("MusicalTraining", goldMsiItems_All, goldMsi_likert_preamble_html);
    const goldMsi_emotions_survey_trial = createGoldMsiSurveyTrial("Emotions", goldMsiItems_All, goldMsi_likert_preamble_html);

    const goldMsi_extra_questions_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'gold-msi-extra-questions' },
        preamble: `<div class='survey-preamble'><strong>Zusätzliche musikalische Angaben:</strong></div>`,
        html: `
            <div class="jspsych-survey-html-form-question">
                <p class="question-text">Das Instrument (einschließlich Gesang), welches ich am besten spiele ist:</p>
                <input type="text" name="BI_01_best_instrument" class="free-text-instrument" placeholder="z.B. Klavier, Gitarre, Gesang...">
            </div>
            ${createRadioGroup("ST_01_start_age", "Mit wie viel Jahren hast du angefangen, ein Instrument zu spielen?", [
                {value: "2-5", label: "2 - 5 Jahre"}, {value: "6-9", label: "6 - 9 Jahre"},
                {value: "10-13", label: "10 - 13 Jahre"}, {value: "14-17", label: "14 - 17 Jahre"},
                {value: "18-19", label: "18 - 19 Jahre"}, {value: "ueber_19", label: "Älter als 19 Jahre"},
                {value: "spiele_kein_instrument", label: "Ich spiele kein Instrument"}
            ])}
            ${createRadioGroup("AP_01_absolute_pitch", "Hast du ein absolutes Gehör? (Ein absolutes Gehör ist die Fähigkeit, einen Ton in Isolation ohne Bezugston zu erkennen und zu benennen, z.B. in der Lage zu sein, ein Fis zu erkennen, wenn jemand ein Fis auf dem Klavier spielt.)", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"},
                {value: "unsicher", label: "Unsicher / Weiß nicht"}
            ])}
        `,
        button_label: "Weiter zum nächsten Fragebogen"
    };

    const aims_likert_scale_labels_german = [ "Stimme überhaupt nicht zu", "Stimme nicht zu", "Neutral (weder noch)", "Stimme zu", "Stimme voll und ganz zu" ];
    const aimsItems_german_with_labels = [
        { prompt: "Manchmal bewege ich meine Hand, als ob ich Musik dirigieren würde.", name: 'AIMS_01', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören vergesse ich manchmal kurzzeitig, wo ich bin.", name: 'AIMS_02', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal fühle ich mich eins mit der Musik.", name: 'AIMS_03', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören kann ich mich so darin vertiefen, dass ich nichts anderes mehr mitbekomme.", name: 'AIMS_04', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Wenn ich mich von niemandem verstanden fühle, mache ich oft Musik an.", name: 'AIMS_05', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich lasse alles stehen und liegen, um ein besonderes Lied/Musikstück zu hören, das gerade gespielt wird.", name: 'AIMS_06', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich kann mir ein Lied/Musikstück so lebhaft vorstellen, dass es mich völlig fesselt, als würde ich es 'live' hören.", name: 'AIMS_07', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Bei guter Musik verliere ich oft den Faden und vergesse, worüber ich gerade nachgedacht habe.", name: 'AIMS_08', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören habe ich manchmal das Gefühl, als könnte mein Verstand die ganze Welt erfassen.", name: 'AIMS_09', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich habe manchmal das Gefühl, die Absichten des Songschreibers/Komponisten vollkommen zu verstehen.", name: 'AIMS_10', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich kann fast jedes Geräusch in Musik verwandeln, je nachdem, wie ich mich darauf einlasse.", name: 'AIMS_11', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Es ist schon vorgekommen, dass ich unterwegs stehen geblieben bin, um Musik zu hören, die ich zufällig mitbekommen habe.", name: 'AIMS_12', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören kann es passieren, dass ich mich so darin verliere, dass ich mich selbst und meine Umgebung vergesse.", name: 'AIMS_13', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Um mich kreativ zu fühlen, höre ich Musik.", name: 'AIMS_14', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal gelingt es mir, völlig in Musik einzutauchen, und ich habe dann das Gefühl, als hätte sich mein gesamter Bewusstseinszustand vorübergehend verändert.", name: 'AIMS_15', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich kann nachvollziehen, was Leute meinen, wenn sie von bewusstseinsverändernden Musikerlebnissen sprechen.", name: 'AIMS_16', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören fühle ich mich manchmal stärker mit anderen Menschen verbunden.", name: 'AIMS_17', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Für mich haben verschiedene Klänge unterschiedliche Farben (z.B. rot, blau).", name: 'AIMS_18', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich höre jeden Tag so viel Musik wie möglich.", name: 'AIMS_19', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal erlebe ich durch Musik Gefühle und Dinge wieder, so wie ich sie als Kind erlebt habe.", name: 'AIMS_20', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal kommt es mir fast so vor, als sei ein Lied speziell für mich oder über mich geschrieben worden.", name: 'AIMS_21', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal passe ich meine Bewegungen oder Handlungen (Türen öffnen, Knöpfe drücken, von Bordsteinen treten) der Musik an.", name: 'AIMS_22', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich entdecke gerne Muster in alltäglichen Geräuschen.", name: 'AIMS_23', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören kann ich jedes Gefühl für die Zeit verlieren.", name: 'AIMS_24', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Bevor ich mit einer Tätigkeit beginne (z.B. Sport, Lernen), überlege ich mir meist genau, welche Musik dazu passen könnte.", name: 'AIMS_25', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Der Klang einer (Sprech-)Stimme kann mich derart faszinieren, dass ich einfach immer weiter zuhören möchte.", name: 'AIMS_26', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Musik hilft mir manchmal, aus mir 'herauszukommen' und einen völlig anderen Zustand zu erleben.", name: 'AIMS_27', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören stelle ich mir oft vor, wie die Musiker die Lieder gerade spielen.", name: 'AIMS_28', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Bei großartiger Musik habe ich manchmal das Gefühl, als würde ich schweben.", name: 'AIMS_29', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Wenn ich Musik höre, gelingt es mir, alles andere auszublenden.", name: 'AIMS_30', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal tauchen beim Musikhören lebhafte Bilder vor meinem inneren Auge auf.", name: 'AIMS_31', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich schließe manchmal die Augen, um mich ganz auf die Musik konzentrieren zu können, die ich höre.", name: 'AIMS_32', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Es gibt Zeiten, da tue ich nichts anderes, als Musik zu hören.", name: 'AIMS_33', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören fühle ich mich manchmal als Teil von etwas, das größer ist als ich selbst.", name: 'AIMS_34', labels: aims_likert_scale_labels_german, required: true }
    ];
    const aims_survey_trial = {
        type: jsPsychSurveyLikert, questions: aimsItems_german_with_labels, randomize_question_order: true,
        preamble: `<div class='survey-preamble'><strong>AIMS Skala:</strong><br>1 = Stimme überhaupt nicht zu; 2 = Stimme nicht zu; 3 = Neutral (weder noch); 4 = Stimme zu; 5 = Stimme voll und ganz zu</div>`,
        scale_width: 600, button_label: 'Weiter', data: { task: 'aims' }
    };

    const phase3_tech_comfort_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase3_tech_comfort' },
        preamble: `<div class='survey-section-title'>Abschnitt E: Technische Aspekte und Komfort</div>`,
        html: `
            ${createRadioGroup("P3_E1_headset_comfort", "Wie komfortabel empfanden Sie das Tragen des Headsets während des Experiments?", [
                {value: "1", label: "1 (Sehr unbequem)"}, {value: "2", label: "2"}, {value: "3", label: "3"}, {value: "4", label: "4 (Neutral)"},
                {value: "5", label: "5"}, {value: "6", label: "6"}, {value: "7", label: "7 (Sehr bequem)"}
            ])}
            ${createRadioGroup("P3_E2_unwohlsein_symptome", "Haben Sie während des Experiments Symptome von Unwohlsein (z.B. Schwindel, Übelkeit, Kopfschmerzen, Augenbelastung) verspürt?", [
                {value: "nein", label: "Nein"}, {value: "ja_leicht", label: "Ja, leicht"},
                {value: "ja_mittel", label: "Ja, mittelstark"}, {value: "ja_stark", label: "Ja, stark"}
            ])}
            <div id="P3_E2a_symptome_beschreibung_wrapper" style="display:none; margin-top:10px; margin-bottom: 2.5em;">
                 <p class="question-text">Falls ja, könnten Sie kurz beschreiben, welche Symptome und wann diese auftraten?</p>
                 <textarea name="P3_E2a_symptome_beschreibung" id="P3_E2a_symptome_beschreibung" rows="3"></textarea>
            </div>
            ${createRadioGroup("P3_E3_tech_probleme", "Gab es technische Probleme während des Experiments (z.B. mit Controllern, Bild, Ton)?", [
                {value: "nein", label: "Nein"}, {value: "ja", label: "Ja"}
            ])}
            <div id="P3_E3a_probleme_beschreibung_wrapper" style="display:none; margin-top:10px; margin-bottom: 2.5em;">
                <p class="question-text">Wenn ja, bitte kurz beschreiben:</p>
                <textarea name="P3_E3a_probleme_beschreibung" id="P3_E3a_probleme_beschreibung" rows="3"></textarea>
            </div>`,
        on_load: function(){
            document.querySelectorAll('input[name="P3_E2_unwohlsein_symptome"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('P3_E2a_symptome_beschreibung_wrapper').style.display = (this.value !== 'nein' && this.checked) ? 'block' : 'none';
                    if (this.value === 'nein') { document.getElementById('P3_E2a_symptome_beschreibung').value = ''; }
                });
            });
            document.querySelectorAll('input[name="P3_E3_tech_probleme"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('P3_E3a_probleme_beschreibung_wrapper').style.display = (this.value === 'ja' && this.checked) ? 'block' : 'none';
                    if (this.value === 'nein') { document.getElementById('P3_E3a_probleme_beschreibung').value = ''; }
                });
            });
            const initialE2Checked = document.querySelector('input[name="P3_E2_unwohlsein_symptome"]:checked');
            document.getElementById('P3_E2a_symptome_beschreibung_wrapper').style.display = (initialE2Checked && initialE2Checked.value !== 'nein') ? 'block' : 'none';
            const initialE3Checked = document.querySelector('input[name="P3_E3_tech_probleme"]:checked');
            document.getElementById('P3_E3a_probleme_beschreibung_wrapper').style.display = (initialE3Checked && initialE3Checked.value === 'ja') ? 'block' : 'none';
        },
        button_label: "Weiter"
    };

    const phase3_active_feedback_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase3_active_feedback' },
        preamble: `<div class='survey-section-title'>Abschnitt F: Feedback zur "Active"-Interaktion</div>`,
        html: `
            ${createRadioGroup("P3_F1_active_einfachheit", "Wenn Sie an die Bedingung denken, in der Sie die Visualisierung aktiv beeinflussen konnten: Wie einfach oder schwierig fanden Sie es, die Visualisierung mit den Controllern zu beeinflussen?", [
                {value: "1", label: "1 (Sehr schwierig)"}, {value: "2", label: "2"}, {value: "3", label: "3"}, {value: "4", label: "4 (Neutral)"},
                {value: "5", label: "5"}, {value: "6", label: "6"}, {value: "7", label: "7 (Sehr einfach)"}
            ])}
            ${createRadioGroup("P3_F2_active_kontrolle", "Wenn Sie an die Bedingung denken, in der Sie die Visualisierung aktiv beeinflussen konnten: Inwieweit hatten Sie das Gefühl, Kontrolle über die Visualisierung zu haben?", [
                {value: "1", label: "1 (Überhaupt keine Kontrolle)"}, {value: "2", label: "2"}, {value: "3", label: "3"}, {value: "4", label: "4 (Neutral)"},
                {value: "5", label: "5"}, {value: "6", label: "6"}, {value: "7", label: "7 (Vollständige Kontrolle)"}
            ])}
        `,
        button_label: "Studie abschließen und Daten speichern"
    };

    // --- ZEITSTRAHL ---
    const timeline = [];
    timeline.push(researcher_input_trial);
    timeline.push(phase1_instructions);
    timeline.push(phase1_demographics_experience_trial);
    timeline.push(phase2_experiment_instructions);
    timeline.push(phase3_instructions);
    timeline.push(phase3_music_feedback_trial);
    timeline.push(goldMsi_instructions_trial_phase3);
    timeline.push(goldMsi_ae_survey_trial);
    timeline.push(goldMsi_mt_survey_trial);
    timeline.push(goldMsi_emotions_survey_trial);
    timeline.push(goldMsi_extra_questions_trial);
    timeline.push(aims_survey_trial);
    timeline.push(phase3_tech_comfort_trial);
    timeline.push(phase3_active_feedback_trial);

    jsPsych.run(timeline);

</script>
</html>