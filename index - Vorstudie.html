<!DOCTYPE html>
<html>
<head>
    <title>Musik & immersive Welten Studie</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css">
    <style>
        body { font-family: Arial, Helvetica, sans-serif; line-height: 1.6; }
        .jspsych-display-element { font-size: 16px; }
        .jspsych-content { max-width: 800px; margin: auto; padding-bottom: 50px; /* Platz für den letzten Button */ }
        .survey-section-title {
            font-size: 1.5em; font-weight: bold; margin-top: 30px;
            margin-bottom: 20px; text-align: center;
            border-bottom: 1px solid #ccc; padding-bottom: 10px;
        }
        .jspsych-survey-html-form-question,
        .jspsych-survey-likert-statement { /* Gilt für Likert-Fragen */
            margin-bottom: 2.5em; text-align: left;
        }
        .jspsych-survey-html-form-question label,
        .jspsych-survey-likert-opts label {
            margin-right: 1em;
            font-weight: normal;
            display: block;
            margin-bottom: 8px;
        }
        .jspsych-survey-likert-opts label { /* Spezifisch für Likert-Optionen, um sie nebeneinander zu bekommen */
            display: inline-block !important; /* Wichtig für Nebeneinander */
            margin-right: 10px !important;
            margin-bottom: 0 !important; /* Kein unterer Rand für Likert-Optionen */
            text-align: center; /* Zentriert Text unter Radio-Button */
            width: auto !important; /* Automatische Breite basierend auf Inhalt */
        }
         .jspsych-survey-likert-opt-label { /* Nur für den Text der Likert-Optionen */
            display: block;
            margin-top: 5px; /* Kleiner Abstand zwischen Radio und Text */
        }


        .survey-preamble {
            max-width: 750px; margin-left: auto; margin-right: auto; margin-bottom: 25px;
            padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;
            text-align: left; border-radius: 5px;
        }
        .question-text { font-weight: bold; margin-bottom: 10px; display: block; }
        .jspsych-survey-html-form-question input[type="radio"],
        .jspsych-survey-html-form-question input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        .jspsych-instructions-nav { margin-top: 20px; }
        .jspsych-btn { margin: 10px 5px; padding: 10px 20px; font-size: 1em; }

        .researcher-input-form div { margin-bottom: 15px; text-align: left; }
        .researcher-input-form label {
            display: inline-block; width: 250px; margin-right: 10px; font-weight: bold;
            vertical-align: middle;
        }
        .researcher-input-form input[type="text"],
        .researcher-input-form select {
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 280px;
            vertical-align: middle;
        }
        textarea { width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
        .jspsych-survey-html-form-group { 
            padding-left: 0px; 
        }
    </style>
</head>
<body>
</body>
<script>

    let researcher_data = {};

    function objectToCsv(dataObject) {
        if (!dataObject || Object.keys(dataObject).length === 0) return "";
        const header = Object.keys(dataObject).join(',');
        const values = Object.values(dataObject).map(val => {
            if (val === null || typeof val === 'undefined') return "";
            if (typeof val === 'string' && (val.includes(',') || val.includes('\n') || val.includes('"'))) {
                return `"${val.replace(/"/g, '""')}"`;
            }
            return val;
        }).join(',');
        return header + '\n' + values;
    }

    function downloadTextAsFile(filename, text) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    const jsPsych = initJsPsych({
        on_finish: function(data) {
            const base_filename_part = `VP_${researcher_data.subject_id}_${researcher_data.condition_between}_Gruppe${researcher_data.condition_within_group}`;
            const default_filename = `data_long_${base_filename_part}.csv`;
            jsPsych.data.get().localSave('csv', default_filename);

            const wideData = createWideFormatData(jsPsych.data.get());
            if (wideData) {
                const wide_csv_string = objectToCsv(wideData);
                const wide_filename = `data_wide_${base_filename_part}.csv`;
                downloadTextAsFile(wide_filename, wide_csv_string);
            }

            const jaspData = createJaspFriendlyWideData(jsPsych.data.get());
            if (jaspData) {
                const jasp_csv_string = objectToCsv(jaspData);
                const jasp_filename = `data_jasp_${base_filename_part}.csv`; // --- MODIFIED --- filename for clarity
                downloadTextAsFile(jasp_filename, jasp_csv_string);
            }

            console.log("Experiment beendet. Daten wurden gespeichert.");
            document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 20px; text-align: center;">Vielen Dank! Ihre Daten wurden gespeichert.<br>Sie können dieses Fenster nun schließen.</div>`;
        },
        on_data_update: function(data_row) {
            data_row.subject_id = researcher_data.subject_id;
            data_row.condition_between = researcher_data.condition_between;
            data_row.condition_within_group = researcher_data.condition_within_group;
        }
    });

    // --- SSQ DEFINITIONEN ---
    const ssq_scale_labels = [ "0 (gar nicht)", "1 (etwas)", "2 (mittel)", "3 (stark)" ];
    const ssq_items_german = [
        { prompt: "Allgemeines Unwohlsein", name: 'SSQ_01_AllgUnwohlsein', labels: ssq_scale_labels, required: true }, { prompt: "Ermüdung", name: 'SSQ_02_Ermuedung', labels: ssq_scale_labels, required: true }, { prompt: "Kopfschmerzen", name: 'SSQ_03_Kopfschmerzen', labels: ssq_scale_labels, required: true }, { prompt: "Angestrengte Augen", name: 'SSQ_04_AngestrengteAugen', labels: ssq_scale_labels, required: true }, { prompt: "Schwierigkeiten beim Fokussieren (scharf sehen)", name: 'SSQ_05_Fokussieren', labels: ssq_scale_labels, required: true }, { prompt: "Erhöhter Speichelfluss", name: 'SSQ_06_Speichelfluss', labels: ssq_scale_labels, required: true }, { prompt: "Schwitzen", name: 'SSQ_07_Schwitzen', labels: ssq_scale_labels, required: true }, { prompt: "Übelkeit", name: 'SSQ_08_Uebelkeit', labels: ssq_scale_labels, required: true }, { prompt: "Konzentrationsschwierigkeiten", name: 'SSQ_09_Konzentration', labels: ssq_scale_labels, required: true }, { prompt: "Kopfdruck (\"Fullness of Head\")", name: 'SSQ_10_Kopfdruck', labels: ssq_scale_labels, required: true }, { prompt: "Verschwommenes Sehen", name: 'SSQ_11_VerschwommenSehen', labels: ssq_scale_labels, required: true }, { prompt: "Schwindel (Augen offen)", name: 'SSQ_12_SchwindelOffen', labels: ssq_scale_labels, required: true }, { prompt: "Schwindel (Augen geschlossen)", name: 'SSQ_13_SchwindelGeschlossen', labels: ssq_scale_labels, required: true }, { prompt: "Vertigo (starker Schwindel/Gleichgewichtsstörung)", name: 'SSQ_14_Vertigo', labels: ssq_scale_labels, required: true }, { prompt: "Magen macht sich bemerkbar (Stomach awareness)", name: 'SSQ_15_MagenBemerkt', labels: ssq_scale_labels, required: true }, { prompt: "Aufstoßen", name: 'SSQ_16_Aufstossen', labels: ssq_scale_labels, required: true }
    ];
    const ssq_preamble_html = `<div class='survey-preamble'>Bitte geben Sie für jedes der folgenden Symptome an, wie stark Sie es <strong>momentan</strong> empfinden.<br>0 = gar nicht;   1 = etwas;   2 = mittel;   3 = stark</div>`;


    function createWideFormatData(jspsych_data_collection) {
        const wide_data_object = {};
        wide_data_object.subject_id = researcher_data.subject_id || '';
        wide_data_object.condition_between = researcher_data.condition_between || '';
        wide_data_object.condition_within_group = researcher_data.condition_within_group || '';

        const phase1_data = jspsych_data_collection.filter({task: 'phase1_demographics_experience'}).trials[0];
        if (phase1_data && phase1_data.response) {
            for (const [key, value] of Object.entries(phase1_data.response)) { wide_data_object[key] = value; }
        }
        const pre_fitness_data = jspsych_data_collection.filter({task: 'pre_ssq_fitness_check'}).trials[0];
        if (pre_fitness_data && pre_fitness_data.response) {
            for (const [key, value] of Object.entries(pre_fitness_data.response)) { wide_data_object[`pre_fitness_${key}`] = value; }
        }
        const ssq_pre_data = jspsych_data_collection.filter({task: 'ssq_pre'}).trials[0];
        if (ssq_pre_data && ssq_pre_data.response) {
            for (const item of ssq_items_german) { wide_data_object[`pre_${item.name}`] = ssq_pre_data.response[item.name];}
        }
        const ssq_post_data = jspsych_data_collection.filter({task: 'ssq_post'}).trials[0];
        if (ssq_post_data && ssq_post_data.response) {
            for (const item of ssq_items_german) { wide_data_object[`post_${item.name}`] = ssq_post_data.response[item.name];}
        }
        // --- NEW: Plausibility Questionnaire for Wide Format ---
        const plausibility_data = jspsych_data_collection.filter({task: 'plausibility_questionnaire'}).trials[0];
        if (plausibility_data && plausibility_data.response) {
            for (const item of plausibility_items_german) { // Iterate using the defined items to ensure all are captured
                wide_data_object[item.name] = plausibility_data.response[item.name];
            }
        }
        // --- END NEW ---

        const phase3_music_feedback = jspsych_data_collection.filter({task: 'phase3_music_feedback'}).trials[0];
        if (phase3_music_feedback && phase3_music_feedback.response) {
            for (const [key, value] of Object.entries(phase3_music_feedback.response)) { wide_data_object[key] = value; }
        }
        const gold_msi_em_trial = jspsych_data_collection.filter({task: 'gold-msi', subscale: 'Emotions'}).trials[0];
        if (gold_msi_em_trial && gold_msi_em_trial.response) {
            for (const [key, value] of Object.entries(gold_msi_em_trial.response)) { wide_data_object[key] = value; }
        }
        const gold_msi_mt_trial = jspsych_data_collection.filter({task: 'gold-msi', subscale: 'MusicalTraining'}).trials[0];
        if (gold_msi_mt_trial && gold_msi_mt_trial.response) {
            for (const [key, value] of Object.entries(gold_msi_mt_trial.response)) { wide_data_object[key] = value; }
        }
        const gold_msi_ae_trial = jspsych_data_collection.filter({task: 'gold-msi', subscale: 'ActiveEngagement'}).trials[0];
        if (gold_msi_ae_trial && gold_msi_ae_trial.response) {
            for (const [key, value] of Object.entries(gold_msi_ae_trial.response)) { wide_data_object[key] = value; }
        }
        const additional_music_q_trial = jspsych_data_collection.filter({task: 'phase3_additional_music_questions'}).trials[0];
        if (additional_music_q_trial && additional_music_q_trial.response) {
            for (const [key, value] of Object.entries(additional_music_q_trial.response)) { wide_data_object[key] = value; }
        }
        const aims_trial = jspsych_data_collection.filter({task: 'aims'}).trials[0];
        if (aims_trial && aims_trial.response) {
            const original_aims_item_names = aimsItems_german_with_labels.map(item => item.name);
            for (const itemName of original_aims_item_names) {
                wide_data_object[itemName] = aims_trial.response.hasOwnProperty(itemName) ? aims_trial.response[itemName] : '';
            }
        }
        const phase3_tech_comfort = jspsych_data_collection.filter({task: 'phase3_tech_comfort'}).trials[0];
        if (phase3_tech_comfort && phase3_tech_comfort.response) {
            for (const [key, value] of Object.entries(phase3_tech_comfort.response)) { wide_data_object[key] = value; }
        }
        const phase3_active_feedback = jspsych_data_collection.filter({task: 'phase3_active_feedback'}).trials[0];
        if (phase3_active_feedback && phase3_active_feedback.response) {
            for (const [key, value] of Object.entries(phase3_active_feedback.response)) { wide_data_object[key] = value; }
        }
        return wide_data_object;
    }

    function createJaspFriendlyWideData(jspsych_data_collection) {
        const jasp_data = {};
        const parseToInt = (val) => val === null || typeof val === 'undefined' || val === '' ? '' : parseInt(val, 10);
        const parseToFloat = (val) => val === null || typeof val === 'undefined' || val === '' ? '' : parseFloat(String(val).replace(',', '.'));
        const yesNoMap = { "ja": 1, "nein": 0, "unsicher": 99 }; // Added "unsicher" for AP_01_abs_gehoer
        const genderMap = { "maennlich": 1, "weiblich": 2, "divers": 3, "keine_angabe": 99 };
        const frequencyMap = { "nie": 0, "seltener_1m": 1, "ca_1m": 2, "mehrmals_m": 3, "ca_1w": 4, "mehrmals_w": 5, "taeglich": 6 };
        const musicKnownMap = { "ja": 1, "nein": 0 };
        const hedwigLikeMap = { "1":1,"2":2,"3":3,"4":4,"5":5,"6":6,"7":7, "kann_nicht_beurteilen": 98 };
        const unwohlseinMap = { "nein": 0, "ja_leicht": 1, "ja_mittel": 2, "ja_stark": 3 };
        // --- MODIFIED --- alterBeginnMap mapping for ST_01_alter_beginn
        const alterBeginnMap = {
            "2-5": 1, "6-9": 2, "10-13": 3, "14-17": 4,
            "18_oder_aelter": 5, "spiele_kein_instrument": 0
        };

        jasp_data.subject_id = researcher_data.subject_id || '';
        jasp_data.condition_between = researcher_data.condition_between || '';
        jasp_data.condition_within_group = researcher_data.condition_within_group || '';

        const phase1_data = jspsych_data_collection.filter({task: 'phase1_demographics_experience'}).trials[0];
        if (phase1_data && phase1_data.response) {
            const r = phase1_data.response;
            jasp_data.P1_alter = r.P1_alter ? parseToInt(r.P1_alter) : '';
            jasp_data.P1_geschlecht = r.P1_geschlecht ? (genderMap[r.P1_geschlecht] !== undefined ? genderMap[r.P1_geschlecht] : '') : '';
            jasp_data.P1_sehvermoegen = r.P1_sehvermoegen ? (yesNoMap[r.P1_sehvermoegen] !== undefined ? yesNoMap[r.P1_sehvermoegen] : '') : '';
            jasp_data.P1_hoervermoegen = r.P1_hoervermoegen ? (yesNoMap[r.P1_hoervermoegen] !== undefined ? yesNoMap[r.P1_hoervermoegen] : '') : '';
            jasp_data.P1_erfahrung_vr = r.P1_erfahrung_vr ? parseToInt(r.P1_erfahrung_vr) : '';
            jasp_data.P1_erfahrung_ar = r.P1_erfahrung_ar ? parseToInt(r.P1_erfahrung_ar) : '';
            jasp_data.P1_nutzung_vr_12m = r.P1_nutzung_vr_12m ? (frequencyMap[r.P1_nutzung_vr_12m] !== undefined ? frequencyMap[r.P1_nutzung_vr_12m] : '') : '';
            jasp_data.P1_nutzung_ar_12m = r.P1_nutzung_ar_12m ? (frequencyMap[r.P1_nutzung_ar_12m] !== undefined ? frequencyMap[r.P1_nutzung_ar_12m] : '') : '';
        }
        const pre_fitness_data = jspsych_data_collection.filter({task: 'pre_ssq_fitness_check'}).trials[0];
        if (pre_fitness_data && pre_fitness_data.response) {
            const r = pre_fitness_data.response;
            jasp_data.pre_fitness_P1_fitness_krank = r.P1_fitness_krank ? (yesNoMap[r.P1_fitness_krank] !== undefined ? yesNoMap[r.P1_fitness_krank] : '') : '';
            jasp_data.pre_fitness_P1_krank_beschreibung = r.P1_krank_beschreibung || '';
            jasp_data.pre_fitness_P1_fitness_ueblich = r.P1_fitness_ueblich ? (yesNoMap[r.P1_fitness_ueblich] !== undefined ? yesNoMap[r.P1_fitness_ueblich] : '') : '';
            jasp_data.pre_fitness_P1_fitness_abweichung = r.P1_fitness_abweichung || '';
            jasp_data.pre_fitness_P1_alkohol_24h = r.P1_alkohol_24h ? (yesNoMap[r.P1_alkohol_24h] !== undefined ? yesNoMap[r.P1_alkohol_24h] : '') : '';
            jasp_data.pre_fitness_P1_medikamente_aktuell = r.P1_medikamente_aktuell ? (yesNoMap[r.P1_medikamente_aktuell] !== undefined ? yesNoMap[r.P1_medikamente_aktuell] : '') : '';
            jasp_data.pre_fitness_P1_medikamente_beschreibung = r.P1_medikamente_beschreibung || '';
        }
        const ssq_pre_data = jspsych_data_collection.filter({task: 'ssq_pre'}).trials[0];
        if (ssq_pre_data && ssq_pre_data.response) {
            for (const item of ssq_items_german) { jasp_data[`pre_${item.name}`] = ssq_pre_data.response[item.name] !== null && ssq_pre_data.response[item.name] !== undefined ? parseToInt(ssq_pre_data.response[item.name]) : ''; }
        }
        const ssq_post_data = jspsych_data_collection.filter({task: 'ssq_post'}).trials[0];
        if (ssq_post_data && ssq_post_data.response) {
            for (const item of ssq_items_german) { jasp_data[`post_${item.name}`] = ssq_post_data.response[item.name] !== null && ssq_post_data.response[item.name] !== undefined ? parseToInt(ssq_post_data.response[item.name]) : ''; }
        }

        // --- NEW: Plausibility Questionnaire for JASP-friendly Format ---
        const plausibility_data_jasp = jspsych_data_collection.filter({task: 'plausibility_questionnaire'}).trials[0];
        if (plausibility_data_jasp && plausibility_data_jasp.response) {
            for (const item of plausibility_items_german) { // Iterate using defined items
                 const val = plausibility_data_jasp.response[item.name];
                 jasp_data[item.name] = val !== null && val !== undefined ? parseToInt(val) : '';
            }
        }
        // --- END NEW ---

        const phase3_music_feedback = jspsych_data_collection.filter({task: 'phase3_music_feedback'}).trials[0];
        if (phase3_music_feedback && phase3_music_feedback.response) {
            const r = phase3_music_feedback.response;
            jasp_data.P3_C1_musik_bekannt = r.P3_C1_musik_bekannt ? (musicKnownMap[r.P3_C1_musik_bekannt] !== undefined ? musicKnownMap[r.P3_C1_musik_bekannt] : '') : '';
            jasp_data.P3_C2_genre_filmmusik_like = r.P3_C2_genre_filmmusik_like ? parseToInt(r.P3_C2_genre_filmmusik_like) : '';
            jasp_data.P3_C3_hedwig_like = r.P3_C3_hedwig_like ? (hedwigLikeMap[r.P3_C3_hedwig_like] !== undefined ? hedwigLikeMap[r.P3_C3_hedwig_like] : parseToInt(r.P3_C3_hedwig_like)) : '';
        }
        const gold_msi_em_trial = jspsych_data_collection.filter({task: 'gold-msi', subscale: 'Emotions'}).trials[0];
        if (gold_msi_em_trial && gold_msi_em_trial.response) {
            for (const [key, value] of Object.entries(gold_msi_em_trial.response)) { jasp_data[key] = value !== null && value !== undefined ? parseToInt(value) : ''; }
        }
        const gold_msi_mt_trial = jspsych_data_collection.filter({task: 'gold-msi', subscale: 'MusicalTraining'}).trials[0];
        if (gold_msi_mt_trial && gold_msi_mt_trial.response) {
            for (const [key, value] of Object.entries(gold_msi_mt_trial.response)) {
                if (key === "MT_03" || key === "MT_07") { jasp_data[key] = value !== null && value !== undefined ? parseToInt(value) : ''; }
                else { let parsedVal = parseToFloat(value); jasp_data[key] = !isNaN(parsedVal) ? parsedVal : (value || ''); }
            }
        }
        const gold_msi_ae_trial = jspsych_data_collection.filter({task: 'gold-msi', subscale: 'ActiveEngagement'}).trials[0];
        if (gold_msi_ae_trial && gold_msi_ae_trial.response) {
            for (const [key, value] of Object.entries(gold_msi_ae_trial.response)) {
                if (["AE_01", "AE_02", "AE_03", "AE_05", "AE_06", "AE_07", "AE_09"].includes(key)) {
                    jasp_data[key] = value !== null && value !== undefined ? parseToInt(value) : '';
                } else { 
                    jasp_data[key] = value || ''; // As text for categorical, or map later if needed
                }
            }
        }
        const additional_music_q_trial = jspsych_data_collection.filter({task: 'phase3_additional_music_questions'}).trials[0];
        if (additional_music_q_trial && additional_music_q_trial.response) {
            const r = additional_music_q_trial.response;
            jasp_data.BI_01_instrument = r.BI_01_instrument || '';
            jasp_data.ST_01_alter_beginn = r.ST_01_alter_beginn ? (alterBeginnMap[r.ST_01_alter_beginn] !== undefined ? alterBeginnMap[r.ST_01_alter_beginn] : '') : '';
            jasp_data.AP_01_abs_gehoer = r.AP_01_abs_gehoer ? (yesNoMap[r.AP_01_abs_gehoer] !== undefined ? yesNoMap[r.AP_01_abs_gehoer] : '') : '';
        }

        const aims_trial = jspsych_data_collection.filter({task: 'aims'}).trials[0];
        if (aims_trial && aims_trial.response) {
            const original_aims_item_names = aimsItems_german_with_labels.map(item => item.name);
            for (const itemName of original_aims_item_names) { const val = aims_trial.response[itemName]; jasp_data[itemName] = val !== null && val !== undefined ? parseToInt(val) : ''; }
        }
        const phase3_tech_comfort = jspsych_data_collection.filter({task: 'phase3_tech_comfort'}).trials[0];
        if (phase3_tech_comfort && phase3_tech_comfort.response) {
            const r = phase3_tech_comfort.response;
            jasp_data.P3_E1_headset_comfort = r.P3_E1_headset_comfort ? parseToInt(r.P3_E1_headset_comfort) : '';
            jasp_data.P3_E2_unwohlsein_symptome = r.P3_E2_unwohlsein_symptome ? (unwohlseinMap[r.P3_E2_unwohlsein_symptome] !== undefined ? unwohlseinMap[r.P3_E2_unwohlsein_symptome] : '') : '';
            jasp_data.P3_E2a_symptome_beschreibung = r.P3_E2a_symptome_beschreibung || '';
            jasp_data.P3_E3_tech_probleme = r.P3_E3_tech_probleme ? (yesNoMap[r.P3_E3_tech_probleme] !== undefined ? yesNoMap[r.P3_E3_tech_probleme] : '') : '';
            jasp_data.P3_E3a_probleme_beschreibung = r.P3_E3a_probleme_beschreibung || '';
        }
        const phase3_active_feedback = jspsych_data_collection.filter({task: 'phase3_active_feedback'}).trials[0];
        if (phase3_active_feedback && phase3_active_feedback.response) {
            const r = phase3_active_feedback.response;
            jasp_data.P3_F1_active_einfachheit = r.P3_F1_active_einfachheit ? parseToInt(r.P3_F1_active_einfachheit) : '';
            jasp_data.P3_F2_active_kontrolle = r.P3_F2_active_kontrolle ? parseToInt(r.P3_F2_active_kontrolle) : '';
        }
        return jasp_data;
    }

    const researcher_input_trial = {
        type: jsPsychSurveyHtmlForm,
        preamble: `<div style="text-align:center; margin-bottom:20px;"><h2>Einstellungen für den Versuchsdurchlauf</h2><p>Bitte geben Sie die folgenden Informationen ein:</p></div>`,
        html: `<div class="researcher-input-form"><div><label for="subject_id">Subject ID:</label><input type="text" id="subject_id" name="subject_id" required placeholder="z.B. VP001"></div><div><label for="condition_between">Between Subject (Technologie):</label><select id="condition_between" name="condition_between" required><option value="">-- Bitte wählen --</option><option value="AR">AR (Augmented Reality)</option><option value="VR">VR (Virtual Reality)</option></select></div><div><label for="condition_within_group">Within Randomisation Group:</label><select id="condition_within_group" name="condition_within_group" required><option value="">-- Bitte wählen --</option><option value="A">Gruppe A (Control -> No interaction -> Interaction)</option><option value="B">Gruppe B (Control -> Interaction -> No interaction)</option></select></div></div>`,
        button_label: 'Experiment starten',
        on_finish: function(data) {
            researcher_data = {
                subject_id: data.response.subject_id,
                condition_between: data.response.condition_between,
                condition_within_group: data.response.condition_within_group
            };
        }
    };

    const phase1_instructions = {
        type: jsPsychInstructions,
        pages: [
            `<div class='survey-section-title'>Fragebogen: Teil 1</div><p style="text-align:center;">Willkommen zur Studie! Bitte beantworten Sie zunächst einige allgemeine Fragen zu Ihrer Person und Ihren Vorerfahrungen.</p>`
        ],
        show_clickable_nav: true, button_label_next: "Weiter", data: {task: "phase1_intro"}
    };

    function createRadioGroup(name, questionText, options) {
        let html = `<div class="jspsych-survey-html-form-question"><p class="question-text">${questionText}</p><div class="jspsych-survey-html-form-group">`; 
        options.forEach(opt => {
            html += `<label style="display:block; margin-bottom:5px;"><input type="radio" name="${name}" value="${opt.value}" required> ${opt.label}</label>`;
        });
        html += `</div></div>`;
        return html;
    }
    function createLikertRadioGroup(name, questionText, options, scaleDescription) {
        let html = `<div class="jspsych-survey-html-form-question"><p class="question-text">${questionText}</p>`;
        if(scaleDescription) html += `<p style="font-size:0.9em; margin-bottom:10px;">${scaleDescription}</p>`;
        html += `<div class="jspsych-survey-html-form-group" style="display:flex; justify-content:space-around; flex-wrap: wrap;">`; 
        options.forEach(opt => {
            html += `<label style="text-align:center; display:flex; flex-direction:column; align-items:center; margin: 5px 10px; min-width: 30px;">
                       <span style="margin-bottom:3px; font-size:0.9em;">${opt.label}</span>
                       <input type="radio" name="${name}" value="${opt.value}" required>
                     </label>`;
        });
        html += `</div></div>`;
        return html;
    }


    const phase1_demographics_experience_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase1_demographics_experience' },
        preamble: `<div class='survey-section-title'>Abschnitt A: Demographische Angaben & Erfahrung mit VR/AR</div>`,
        html: `
            <div class="jspsych-survey-html-form-question">
                <p class="question-text">Bitte geben Sie Ihr Alter an (in Jahren):</p>
                <input type="number" name="P1_alter" required min="1" style="width:100px; padding:8px;">
            </div>
            ${createRadioGroup("P1_geschlecht", "Bitte geben Sie Ihr Geschlecht an:", [
                {value: "maennlich", label: "männlich"}, {value: "weiblich", label: "weiblich"},
                {value: "divers", label: "divers"}, {value: "keine_angabe", label: "keine Angabe"}
            ])}
            ${createRadioGroup("P1_sehvermoegen", "Haben Sie normales oder auf normal korrigiertes Sehvermögen?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            ${createRadioGroup("P1_hoervermoegen", "Haben Sie normales oder auf normal korrigiertes Hörvermögen?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            <hr style="margin: 30px 0;">
            ${createLikertRadioGroup("P1_erfahrung_vr", "Wie würden Sie Ihre bisherige Erfahrung mit Virtual Reality (VR) einschätzen?", [
                {value: "1", label: "1 (Gar keine)"}, {value: "2", label: "2"}, {value: "3", label: "3"},
                {value: "4", label: "4 (Mittelmäßig)"}, {value: "5", label: "5"}, {value: "6", label: "6"},
                {value: "7", label: "7 (Sehr viel)"}
            ])}
            ${createLikertRadioGroup("P1_erfahrung_ar", "Wie würden Sie Ihre bisherige Erfahrung mit Augmented Reality (AR) einschätzen?", [
                {value: "1", label: "1 (Gar keine)"}, {value: "2", label: "2"}, {value: "3", label: "3"},
                {value: "4", label: "4 (Mittelmäßig)"}, {value: "5", label: "5"}, {value: "6", label: "6"},
                {value: "7", label: "7 (Sehr viel)"}
            ])}
            ${createRadioGroup("P1_nutzung_vr_12m", "Wie häufig haben Sie in den letzten 12 Monaten Virtual Reality (VR) genutzt?", [
                {value: "nie", label: "Nie"}, {value: "seltener_1m", label: "Weniger als einmal im Monat"},
                {value: "ca_1m", label: "Etwa einmal im Monat"}, {value: "mehrmals_m", label: "Mehrmals im Monat"},
                {value: "ca_1w", label: "Etwa einmal pro Woche"}, {value: "mehrmals_w", label: "Mehrmals pro Woche"},
                {value: "taeglich", label: "Täglich"}
            ])}
            ${createRadioGroup("P1_nutzung_ar_12m", "Wie häufig haben Sie in den letzten 12 Monaten Augmented Reality (AR) genutzt?", [
                {value: "nie", label: "Nie"}, {value: "seltener_1m", label: "Weniger als einmal im Monat"},
                {value: "ca_1m", label: "Etwa einmal im Monat"}, {value: "mehrmals_m", label: "Mehrmals im Monat"},
                {value: "ca_1w", label: "Etwa einmal pro Woche"}, {value: "mehrmals_w", label: "Mehrmals pro Woche"},
                {value: "taeglich", label: "Täglich"}
            ])}
        `,
        button_label: "Weiter"
    };

    const pre_ssq_fitness_check_trial = {
        type: jsPsychSurveyHtmlForm,
        preamble: `<div class='survey-section-title'>Abschnitt B1: Allgemeines Befinden (Vor dem Experiment)</div>`,
        html: `
            ${createRadioGroup("P1_fitness_krank", "Fühlen Sie sich momentan krank (z.B. Erkältung, Grippe, Magenverstimmung)?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            <div id="P1_krank_beschreibung_wrapper" style="display:none; margin-top:10px; margin-bottom: 2.5em;">
                 <p class="question-text">Falls ja, könnten Sie kurz beschreiben, welche Symptome?</p>
                 <textarea name="P1_krank_beschreibung" id="P1_krank_beschreibung" rows="2" style="width:100%;"></textarea>
            </div>

            ${createRadioGroup("P1_fitness_ueblich", "Befinden Sie sich heute in Ihrem üblichen Zustand der Fitness?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            <div id="P1_fitness_abweichung_wrapper" style="display:none; margin-top:10px; margin-bottom: 2.5em;">
                 <p class="question-text">Falls nein, könnten Sie kurz beschreiben, warum nicht?</p>
                 <textarea name="P1_fitness_abweichung" id="P1_fitness_abweichung" rows="2" style="width:100%;"></textarea>
            </div>

            <p class="question-text" style="margin-top:20px;">Bitte beachten Sie die folgenden Fragen zur Einnahme von Substanzen, die Ihr Befinden beeinflussen könnten:</p>
            ${createRadioGroup("P1_alkohol_24h", "Haben Sie in den letzten 24 Stunden Alkohol konsumiert?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            ${createRadioGroup("P1_medikamente_aktuell", "Nehmen Sie aktuell Medikamente ein, die Ihr Wohlbefinden oder Ihre Reaktionsfähigkeit beeinflussen könnten (z.B. starke Schmerzmittel, Medikamente gegen Reisekrankheit, Beruhigungsmittel)?", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
            ])}
            <div id="P1_medikamente_beschreibung_wrapper" style="display:none; margin-top:10px; margin-bottom: 2.5em;">
                 <p class="question-text">Falls ja, welche (allgemeine Art genügt, z.B. 'Schmerzmittel')?</p>
                 <textarea name="P1_medikamente_beschreibung" id="P1_medikamente_beschreibung" rows="2" style="width:100%;"></textarea>
            </div>
        `,
        button_label: 'Weiter zum Befindens-Fragebogen',
        data: { task: 'pre_ssq_fitness_check'},
        on_load: function(){
            function setupConditionalDisplay(radioGroupName, wrapperId, showConditionValue, textareaId) {
                document.querySelectorAll(`input[name="${radioGroupName}"]`).forEach(radio => {
                    radio.addEventListener('change', function() {
                        document.getElementById(wrapperId).style.display = (this.value === showConditionValue && this.checked) ? 'block' : 'none';
                        if (this.value !== showConditionValue && document.getElementById(textareaId)) {
                            document.getElementById(textareaId).value = ''; // Clear textarea if condition not met
                        }
                    });
                });
                // Initial check
                const initialChecked = document.querySelector(`input[name="${radioGroupName}"]:checked`);
                if (initialChecked) {
                    document.getElementById(wrapperId).style.display = (initialChecked.value === showConditionValue) ? 'block' : 'none';
                } else {
                     document.getElementById(wrapperId).style.display = 'none'; // Hide if no radio is initially checked
                }
            }
            setupConditionalDisplay("P1_fitness_krank", "P1_krank_beschreibung_wrapper", "ja", "P1_krank_beschreibung");
            setupConditionalDisplay("P1_fitness_ueblich", "P1_fitness_abweichung_wrapper", "nein", "P1_fitness_abweichung");
            setupConditionalDisplay("P1_medikamente_aktuell", "P1_medikamente_beschreibung_wrapper", "ja", "P1_medikamente_beschreibung");
        }
    };

    const ssq_pre_trial = {
        type: jsPsychSurveyLikert,
        questions: ssq_items_german,
        randomize_question_order: false,
        preamble: `<div class='survey-section-title'>Abschnitt B2: Aktuelles Befinden (Vor dem Experiment)</div>${ssq_preamble_html}`,
        button_label: 'Weiter zur Instruktion für das Experiment',
        scale_width: 600,
        data: { task: 'ssq_pre' }
    };


    const phase2_experiment_instructions = {
        type: jsPsychInstructions,
        pages: function(){
            const tech = researcher_data.condition_between === "AR" ? "Augmented Reality (AR)" :
                         researcher_data.condition_between === "VR" ? "Virtual Reality (VR)" :
                         "Headset";
            return [
                `<div class='survey-section-title'>Experimentelle Durchführung</div>
                 <p style="text-align:center;">Vielen Dank für das Ausfüllen des ersten Fragebogenteils.</p>
                 <p style="text-align:center;">Das eigentliche Experiment im ${tech} wird nun außerhalb dieses Programms durchgeführt.</p>
                 <p style="text-align:center;">Bitte informieren Sie den Versuchsleiter, dass Sie bereit sind.</p>
                 <p style="text-align:center;">Nach Abschluss des Experiments im ${tech} werden Sie gebeten, hier mit dem letzten Fragebogenteil fortzufahren.</p>`
            ];
        },
        show_clickable_nav: true,
        button_label_next: "Ich habe das Experiment im Headset abgeschlossen und möchte fortfahren",
        data: {task: "phase2_instructions"}
    };

    const ssq_post_trial = {
        type: jsPsychSurveyLikert,
        questions: ssq_items_german,
        randomize_question_order: false,
        preamble: `<div class='survey-section-title'>Abschnitt C1: Aktuelles Befinden (Unmittelbar nach dem Experiment)</div>${ssq_preamble_html}`,
        button_label: 'Weiter',
        scale_width: 600,
        data: { task: 'ssq_post' }
    };


    const phase3_instructions = {
        type: jsPsychInstructions,
        pages: [
            `<div class='survey-section-title'>Abschlussfragebögen: Teil 2</div><p style="text-align:center;">Willkommen zurück! Bitte beantworten Sie nun die letzten Fragebögen.</p>`
        ],
        show_clickable_nav: true, button_label_next: "Weiter", data: {task: "phase3_intro"}
    };

    // --- NEW: Plausibility Questionnaire Definition ---
    const plausibility_likert_scale_labels_german = [ "1 (stimme überhaupt nicht zu)", "2", "3", "4 (neutral)", "5", "6", "7 (stimme voll und ganz zu)" ];
    const plausibility_items_german = [
        // Teil 1: Externe Plausibilität (EP)
        { prompt: "Ich bin es gewohnt, dass sich Objekte (Szenarien/Visualisierungen) auf diese Weise verhalten.", name: 'PPQ_EP_01', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Im Alltag erwarte ich, dass sich Objekte (Szenarien/Visualisierungen) auf diese Weise verhalten.", name: 'PPQ_EP_02', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Ich habe schon einmal erlebt, dass sich Objekte (Szenarien/Visualisierungen) im echten Leben so verhalten.", name: 'PPQ_EP_03', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Das Verhalten der Objekte (des Szenarios/der Visualisierung) ist für mich ungewöhnlich. (invertiert)", name: 'PPQ_EP_04_inv', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Ich kenne dieses Verhalten von Objekten (des Szenarios/der Visualisierung) nicht aus dem echten Leben. (invertiert)", name: 'PPQ_EP_05_inv', labels: plausibility_likert_scale_labels_german, required: true },
        // Teil 2: Interne Plausibilität (IP)
        { prompt: "Ich hatte eine vorherige Erwartung, wie sich die Objekte (das Szenario/die Visualisierung) verhalten würden.", name: 'PPQ_IP_01', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Ich habe erwartet, dass sich die Objekte (das Szenario/die Visualisierung) so verhalten.", name: 'PPQ_IP_02', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Ich habe dieses Verhalten von Objekten (des Szenarios/der Visualisierung) schon einmal in Filmen, Spielen usw. gesehen.", name: 'PPQ_IP_03', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Ich war von dem Verhalten der Objekte (des Szenarios/der Visualisierung) überrascht. (invertiert)", name: 'PPQ_IP_04_inv', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Ich hatte keine Ahnung, dass sich die Objekte (das Szenario/die Visualisierung) so verhalten würden. (invertiert)", name: 'PPQ_IP_05_inv', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Das Verhalten der Objekte (des Szenarios/der Visualisierung) passte zum Szenario/Kontext.", name: 'PPQ_IP_06', labels: plausibility_likert_scale_labels_german, required: true },
        // Teil 3: Allgemeine Plausibilität (GP)
        { prompt: "Das Verhalten der Objekte (des Szenarios/der Visualisierung) ergab Sinn.", name: 'PPQ_GP_01', labels: plausibility_likert_scale_labels_german, required: true },
        { prompt: "Ich denke, dieses Verhalten der Objekte (des Szenarios/der Visualisierung) ist unmöglich. (invertiert)", name: 'PPQ_GP_02_inv', labels: plausibility_likert_scale_labels_german, required: true },
    ];

    const plausibility_questionnaire_trial = {
        type: jsPsychSurveyLikert,
        questions: plausibility_items_german,
        randomize_question_order: false, // Usually better to keep subscales grouped
        preamble: `<div class='survey-section-title'>Fragebogen zur Wahrgenommenen Plausibilität</div>
                   <div class='survey-preamble'>Bitte bewerten Sie die folgenden Aussagen auf einer 7-Punkte-Likert-Skala.<br>
                   1 = stimme überhaupt nicht zu ... 4 = neutral ... 7 = stimme voll und ganz zu</div>`,
        button_label: 'Weiter',
        scale_width: 700, // Adjusted for 7 points
        data: { task: 'plausibility_questionnaire' }
    };
    // --- END NEW ---


    const phase3_music_feedback_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase3_music_feedback' },
        preamble: `<div class='survey-section-title'>Abschnitt C2: Feedback zum Musikstück</div>`,
        html: function() {
            return `
                ${createRadioGroup("P3_C1_musik_bekannt", "Kannten Sie das Musikstück ('Hedwig's Theme'), das während des Experiments gespielt wurde, bereits vorher?", [
                    {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"}
                ], true)}

                ${createLikertRadioGroup("P3_C2_genre_filmmusik_like", "Wie sehr mögen Sie das Genre 'Filmmusik' im Allgemeinen?", [
                    {value: "1", label: "1 (Überhaupt nicht)"}, {value: "2", label: "2"}, {value: "3", label: "3"},
                    {value: "4", label: "4 (Neutral)"}, {value: "5", label: "5"}, {value: "6", label: "6"},
                    {value: "7", label: "7 (Sehr)"}
                ])}

                <div class="jspsych-survey-html-form-question">
                    <p class="question-text">Wie sehr mögen Sie das spezifische Musikstück 'Hedwig's Theme'?</p>
                    <div class="jspsych-survey-html-form-group">
                        <select name="P3_C3_hedwig_like" id="P3_C3_hedwig_like" required style="padding:8px; width:auto; min-width:250px;">
                            <option value="">-- Bitte wählen --</option>
                            <option value="1">1 (Mag ich überhaupt nicht)</option> <option value="2">2</option> <option value="3">3</option>
                            <option value="4">4 (Neutral)</option> <option value="5">5</option> <option value="6">6</option>
                            <option value="7">7 (Mag ich sehr)</option>
                            <option value="kann_nicht_beurteilen">Kann ich nicht beurteilen, da unbekannt</option>
                        </select>
                    </div>
                </div>
            `;
        },
        on_load: function() {
            const radio_c1_nein = document.querySelector('input[name="P3_C1_musik_bekannt"][value="nein"]');
            const radio_c1_ja = document.querySelector('input[name="P3_C1_musik_bekannt"][value="ja"]');
            const select_c3 = document.getElementById('P3_C3_hedwig_like');

            function updateC3Status() {
                if (radio_c1_nein && radio_c1_nein.checked) {
                    select_c3.value = 'kann_nicht_beurteilen';
                } else if (radio_c1_ja && radio_c1_ja.checked) {
                    // Only reset if it was previously 'kann_nicht_beurteilen'
                    if (select_c3.value === 'kann_nicht_beurteilen') {
                         select_c3.value = ""; // Prompt user to select
                    }
                }
            }
            if (radio_c1_ja) radio_c1_ja.addEventListener('change', updateC3Status);
            if (radio_c1_nein) radio_c1_nein.addEventListener('change', updateC3Status);
            
            // Initial state
            const initialChecked = document.querySelector('input[name="P3_C1_musik_bekannt"]:checked');
            if(initialChecked) updateC3Status();
        },
        button_label: "Weiter"
    };

    const goldMsiItems_EM_MT_AE = [
        // Emotions (EM)
        { mid: "EM_01", item: "Ich suche oft Musik aus, bei der ich eine Gänsehaut bekomme.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_02", item: "Musikstücke rufen selten Gefühle in mir hervor.", response_type: "likert7", negative: true, subscale: "Emotions" },
        { mid: "EM_03", item: "Ich suche häufig eine bestimmte Musik aus, um mich zu motivieren oder zu begeistern.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_04", item: "Ich kann identifizieren, was das Besondere an einem bestimmten Musikstück ist.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_05", item: "Ich bin in der Lage, über meine Gefühle, die durch Musik hervorgerufen werden, zu sprechen.", response_type: "likert7", negative: false, subscale: "Emotions" },
        { mid: "EM_06", item: "Musik kann bei mir Erinnerungen an Personen und Orte hervorrufen.", response_type: "likert7", negative: false, subscale: "Emotions" },
        // Musical Training (MT)
        { mid: "MT_01", item: "Ich habe regelmäßig und täglich ein Instrument (einschließlich Gesang) für ____ Jahre geübt.", response_type: "categorical", options: ["0", "1", "2", "3", "4-5", "6-9", "10 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_02", item: "An dem Höhepunkt meines Interesses habe ich mein Hauptinstrument ____ Stunden pro Tag geübt.", response_type: "categorical", options: ["0", "0,5", "1", "1,5", "2", "3-4", "5 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_03", item: "Ich bin noch nie für meine musikalischen Fähigkeiten gelobt worden.", response_type: "likert7", negative: true, subscale: "MusicalTraining" },
        { mid: "MT_04", item: "Ich habe ____ Jahre Unterricht in Musiktheorie (außerhalb der Schule) erhalten.", response_type: "categorical", options: ["0", "0,5", "1", "2", "3", "4-6", "7 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_05", item: "Ich habe ____ Jahre Musikunterricht auf einem Instrument (einschließlich Gesang) in meinem bisherigen Leben gehabt.", response_type: "categorical", options: ["0", "1", "2", "3", "4-5", "6-9", "10 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_06", item: "Ich kann ____ verschiedene Instrumente spielen.", response_type: "categorical", options: ["0", "1", "2", "3", "4", "5", "6 oder mehr"], negative: false, subscale: "MusicalTraining" },
        { mid: "MT_07", item: "Ich würde mich selbst nicht als Musiker/-in bezeichnen.", response_type: "likert7", negative: true, subscale: "MusicalTraining" },
        // Active Engagement (AE) 
        { mid: "AE_01", item: "Ich beschäftige mich in meiner Freizeit viel mit musikbezogenen Aktivitäten.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_02", item: "Ich schreibe gerne über Musik, z. B. in Internetblogs oder Foren.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_03", item: "Ich bin fasziniert von Musikstilen, mit denen ich nicht vertraut bin, und möchte mehr darüber erfahren.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_04", item: "Ich habe ____ Live-Events als Zuschauer innerhalb der letzten 12 Monate besucht.", response_type: "categorical", options: ["0", "1", "2", "3", "4-6", "7-10", "11 oder mehr"], negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_05", item: "Ich lese oder suche oft im Internet nach Dingen, die mit Musik zu tun haben.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_06", item: "Ich gebe nicht viel Geld meines verfügbaren Einkommens für Musik aus.", response_type: "likert7", negative: true, subscale: "ActiveEngagement" },
        { mid: "AE_07", item: "Musik ist für mich eine Art von Sucht – ohne sie könnte ich nicht leben.", response_type: "likert7", negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_08", item: "Ich höre jeden Tag aufmerksam Musik für ____.", response_type: "categorical", options: ["0-15min", "15-30min", "30-60min", "60-90min", "2 Std", "2-3 Std", "4 Std oder mehr"], negative: false, subscale: "ActiveEngagement" },
        { mid: "AE_09", item: "Ich halte mich auf dem Laufenden, was neue Musik angeht (z. B. neue Künstler oder Aufnahmen).", response_type: "likert7", negative: false, subscale: "ActiveEngagement" }
    ];

    function createGoldMsiSurveyQuestionHTML(question) {
        let html = `<span class="question-text">${question.item.replace(/____/g, '___')}</span>
                    <div class="jspsych-survey-html-form-group" style="display:flex; flex-wrap:wrap; justify-content:space-around;">`;
        if (question.response_type === "likert7") {
            for (let i = 1; i <= 7; i++) {
                 html += `<label style="text-align:center; margin: 5px 10px; min-width: 30px;">
                           <span style="display:block; font-size:0.9em; margin-bottom:3px;">${i}</span>
                           <input type="radio" name="${question.mid}" value="${i}" required>
                         </label>`;
            }
        } else if (question.response_type === "categorical") {
            question.options.forEach((option) => {
                html += `<label style="text-align:center; margin: 5px 10px;">
                           <span style="display:block; font-size:0.9em; margin-bottom:3px;">${option}</span>
                           <input type="radio" name="${question.mid}" value="${option.replace(',', '.')}" required>
                         </label>`;
            });
        }
        html += `</div>`; return html;
    }

    const goldMsi_instructions_trial_phase3 = {
        type: jsPsychInstructions, pages: [ `<div class='survey-section-title'>Abschnitt D: Musikalische Vorerfahrung und Absorption</div><p style="text-align:center;">Es folgen nun Fragebögen zu Ihrer allgemeinen musikalischen Erfahrung und Ihrem Erleben von Musik.</p>` ],
        show_clickable_nav: true, button_label_next: "Weiter", data: {task: "goldmsi_aims_intro_p3"}
    };
    const goldMsi_likert_preamble_html = `<div class='survey-preamble' style="text-align:center;"><strong>Gold-MSI Skala:</strong><br>1 = Stimme ganz und gar nicht zu ... 4 = Weder noch ... 7 = Stimme voll und ganz zu</div>`;

    function createGoldMsiSurveyTrial(subscaleName, items, preamble = null) {
        const survey_questions_html = items.filter(q => q.subscale === subscaleName).map(q => `<div class="jspsych-survey-html-form-question">${createGoldMsiSurveyQuestionHTML(q)}</div>`).join('');
        return { type: jsPsychSurveyHtmlForm, preamble: preamble, html: survey_questions_html, button_label: "Weiter", data: { task: 'gold-msi', subscale: subscaleName } };
    }
    const goldMsi_emotions_survey_trial = createGoldMsiSurveyTrial("Emotions", goldMsiItems_EM_MT_AE, goldMsi_likert_preamble_html);
    const goldMsi_training_survey_trial = createGoldMsiSurveyTrial("MusicalTraining", goldMsiItems_EM_MT_AE, goldMsi_likert_preamble_html);
    const goldMsi_active_engagement_survey_trial = createGoldMsiSurveyTrial("ActiveEngagement", goldMsiItems_EM_MT_AE, goldMsi_likert_preamble_html); 

    const phase3_additional_music_questions_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase3_additional_music_questions' },
        preamble: `<div class='survey-section-title'>Zusätzliche musikalische Angaben</div>`,
        html: `
            <div class="jspsych-survey-html-form-question">
                <p class="question-text">Das Instrument (einschließlich Gesang), welches ich am besten spiele ist:</p>
                <input type="text" name="BI_01_instrument" placeholder="z.B. Klavier, Gitarre, Gesang, keines" style="width: 100%; padding:8px;">
            </div>
            ${createRadioGroup("ST_01_alter_beginn", "Mit wie viel Jahren hast du angefangen, ein Instrument zu spielen (oder ernsthaft zu singen)?", [
                {value: "2-5", label: "2-5 Jahre"}, {value: "6-9", label: "6-9 Jahre"},
                {value: "10-13", label: "10-13 Jahre"}, {value: "14-17", label: "14-17 Jahre"},
                {value: "18_oder_aelter", label: "18 Jahre oder älter"},
                {value: "spiele_kein_instrument", label: "Ich spiele kein Instrument / singe nicht ernsthaft."}
            ])}
            ${createRadioGroup("AP_01_abs_gehoer", "Hast du ein absolutes Gehör? (Die Fähigkeit, einen Ton ohne Bezugston zu erkennen und zu benennen)", [
                {value: "ja", label: "Ja"}, {value: "nein", label: "Nein"},
                {value: "unsicher", label: "Ich bin unsicher"}
            ])}
        `,
        button_label: "Weiter"
    };


    const aims_likert_scale_labels_german = [ "Stimme überhaupt nicht zu", "Stimme nicht zu", "Neutral (weder noch)", "Stimme zu", "Stimme voll und ganz zu" ];
    const aimsItems_german_with_labels = [
        { prompt: "Manchmal bewege ich meine Hand, als ob ich Musik dirigieren würde.", name: 'AIMS_01', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören vergesse ich manchmal kurzzeitig, wo ich bin.", name: 'AIMS_02', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal fühle ich mich eins mit der Musik.", name: 'AIMS_03', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören kann ich mich so darin vertiefen, dass ich nichts anderes mehr mitbekomme.", name: 'AIMS_04', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Wenn ich mich von niemandem verstanden fühle, mache ich oft Musik an.", name: 'AIMS_05', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich lasse alles stehen und liegen, um ein besonderes Lied/Musikstück zu hören, das gerade gespielt wird.", name: 'AIMS_06', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich kann mir ein Lied/Musikstück so lebhaft vorstellen, dass es mich völlig fesselt, als würde ich es 'live' hören.", name: 'AIMS_07', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Bei guter Musik verliere ich oft den Faden und vergesse, worüber ich gerade nachgedacht habe.", name: 'AIMS_08', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören habe ich manchmal das Gefühl, als könnte mein Verstand die ganze Welt erfassen.", name: 'AIMS_09', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich habe manchmal das Gefühl, die Absichten des Songschreibers/Komponisten vollkommen zu verstehen.", name: 'AIMS_10', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich kann fast jedes Geräusch in Musik verwandeln, je nachdem, wie ich mich darauf einlasse.", name: 'AIMS_11', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Es ist schon vorgekommen, dass ich unterwegs stehen geblieben bin, um Musik zu hören, die ich zufällig mitbekommen habe.", name: 'AIMS_12', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören kann es passieren, dass ich mich so darin verliere, dass ich mich selbst und meine Umgebung vergesse.", name: 'AIMS_13', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Um mich kreativ zu fühlen, höre ich Musik.", name: 'AIMS_14', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal gelingt es mir, völlig in Musik einzutauchen, und ich habe dann das Gefühl, als hätte sich mein gesamter Bewusstseinszustand vorübergehend verändert.", name: 'AIMS_15', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich kann nachvollziehen, was Leute meinen, wenn sie von bewusstseinsverändernden Musikerlebnissen sprechen.", name: 'AIMS_16', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören fühle ich mich manchmal stärker mit anderen Menschen verbunden.", name: 'AIMS_17', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Für mich haben verschiedene Klänge unterschiedliche Farben (z.B. rot, blau).", name: 'AIMS_18', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich höre jeden Tag so viel Musik wie möglich.", name: 'AIMS_19', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal erlebe ich durch Musik Gefühle und Dinge wieder, so wie ich sie als Kind erlebt habe.", name: 'AIMS_20', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal kommt es mir fast so vor, als sei ein Lied speziell für mich oder über mich geschrieben worden.", name: 'AIMS_21', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal passe ich meine Bewegungen oder Handlungen (Türen öffnen, Knöpfe drücken, von Bordsteinen treten) der Musik an.", name: 'AIMS_22', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich entdecke gerne Muster in alltäglichen Geräuschen.", name: 'AIMS_23', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören kann ich jedes Gefühl für die Zeit verlieren.", name: 'AIMS_24', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Bevor ich mit einer Tätigkeit beginne (z.B. Sport, Lernen), überlege ich mir meist genau, welche Musik dazu passen könnte.", name: 'AIMS_25', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Der Klang einer (Sprech-)Stimme kann mich derart faszinieren, dass ich einfach immer weiter zuhören möchte.", name: 'AIMS_26', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Musik hilft mir manchmal, aus mir 'herauszukommen' und einen völlig anderen Zustand zu erleben.", name: 'AIMS_27', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören stelle ich mir oft vor, wie die Musiker die Lieder gerade spielen.", name: 'AIMS_28', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Bei großartiger Musik habe ich manchmal das Gefühl, als würde ich schweben.", name: 'AIMS_29', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Wenn ich Musik höre, gelingt es mir, alles andere auszublenden.", name: 'AIMS_30', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Manchmal tauchen beim Musikhören lebhafte Bilder vor meinem inneren Auge auf.", name: 'AIMS_31', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Ich schließe manchmal die Augen, um mich ganz auf die Musik konzentrieren zu können, die ich höre.", name: 'AIMS_32', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Es gibt Zeiten, da tue ich nichts anderes, als Musik zu hören.", name: 'AIMS_33', labels: aims_likert_scale_labels_german, required: true }, { prompt: "Beim Musikhören fühle ich mich manchmal als Teil von etwas, das größer ist als ich selbst.", name: 'AIMS_34', labels: aims_likert_scale_labels_german, required: true }
    ];
    const aims_survey_trial = {
        type: jsPsychSurveyLikert, questions: aimsItems_german_with_labels, randomize_question_order: true,
        preamble: `<div class='survey-preamble' style="text-align:center;"><strong>AIMS Skala:</strong><br>Bitte geben Sie an, inwieweit die folgenden Aussagen auf Sie zutreffen.<br>Die Zahlen entsprechen: 1 = Stimme überhaupt nicht zu ... 3 = Neutral ... 5 = Stimme voll und ganz zu</div>`,
        scale_width: 600, button_label: 'Weiter', data: { task: 'aims' }
    };

    const phase3_tech_comfort_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase3_tech_comfort' },
        preamble: `<div class='survey-section-title'>Abschnitt E: Technische Aspekte und Komfort</div>`,
        html: `
            ${createLikertRadioGroup("P3_E1_headset_comfort", "Wie komfortabel empfanden Sie das Tragen des Headsets während des Experiments?", [
                {value: "1", label: "1 (Sehr unbequem)"}, {value: "2", label: "2"}, {value: "3", label: "3"}, {value: "4", label: "4 (Neutral)"},
                {value: "5", label: "5"}, {value: "6", label: "6"}, {value: "7", label: "7 (Sehr bequem)"}
            ])}
            ${createRadioGroup("P3_E2_unwohlsein_symptome", "Haben Sie während oder unmittelbar nach dem Experiment Symptome von Unwohlsein (z.B. Schwindel, Übelkeit, Kopfschmerzen, Augenbelastung) verspürt, die Sie auf die Nutzung des Headsets zurückführen würden?", [
                {value: "nein", label: "Nein"}, {value: "ja_leicht", label: "Ja, leicht"},
                {value: "ja_mittel", label: "Ja, mittelstark"}, {value: "ja_stark", label: "Ja, stark"}
            ])}
            <div id="P3_E2a_symptome_beschreibung_wrapper" style="display:none; margin-top:10px; margin-bottom: 2.5em;">
                 <p class="question-text">Falls ja, könnten Sie kurz beschreiben, welche Symptome und wann diese auftraten?</p>
                 <textarea name="P3_E2a_symptome_beschreibung" id="P3_E2a_symptome_beschreibung" rows="3"></textarea>
            </div>
            ${createRadioGroup("P3_E3_tech_probleme", "Gab es technische Probleme während des Experiments (z.B. mit Controllern, Bild, Ton)?", [
                {value: "nein", label: "Nein"}, {value: "ja", label: "Ja"}
            ])}
            <div id="P3_E3a_probleme_beschreibung_wrapper" style="display:none; margin-top:10px; margin-bottom: 2.5em;">
                <p class="question-text">Wenn ja, bitte kurz beschreiben:</p>
                <textarea name="P3_E3a_probleme_beschreibung" id="P3_E3a_probleme_beschreibung" rows="3"></textarea>
            </div>`,
        on_load: function(){
            function setupConditionalTextarea(radioGroupName, wrapperId, showConditionValues, textareaId) {
                const radios = document.querySelectorAll(`input[name="${radioGroupName}"]`);
                const wrapper = document.getElementById(wrapperId);
                const textarea = document.getElementById(textareaId);
                function updateDisplay() {
                    let show = false;
                    radios.forEach(radio => { if (radio.checked && showConditionValues.includes(radio.value)) { show = true; } });
                    wrapper.style.display = show ? 'block' : 'none';
                    if (!show && textarea) { textarea.value = ''; }
                }
                radios.forEach(radio => radio.addEventListener('change', updateDisplay));
                updateDisplay(); // Initial check
            }
            setupConditionalTextarea("P3_E2_unwohlsein_symptome", "P3_E2a_symptome_beschreibung_wrapper", ["ja_leicht", "ja_mittel", "ja_stark"], "P3_E2a_symptome_beschreibung");
            setupConditionalTextarea("P3_E3_tech_probleme", "P3_E3a_probleme_beschreibung_wrapper", ["ja"], "P3_E3a_probleme_beschreibung");
        },
        button_label: "Weiter"
    };

    const phase3_active_feedback_trial = {
        type: jsPsychSurveyHtmlForm,
        data: { task: 'phase3_active_feedback' },
        preamble: `<div class='survey-section-title'>Abschnitt F: Feedback zur "Active"-Interaktion</div>`,
        html: `
            ${createLikertRadioGroup("P3_F1_active_einfachheit", "Wenn Sie an die Bedingung denken, in der Sie die Visualisierung aktiv beeinflussen konnten: Wie einfach oder schwierig fanden Sie es, die Visualisierung mit den Controllern zu beeinflussen?", [
                {value: "1", label: "1 (Sehr schwierig)"}, {value: "2", label: "2"}, {value: "3", label: "3"}, {value: "4", label: "4 (Neutral)"},
                {value: "5", label: "5"}, {value: "6", label: "6"}, {value: "7", label: "7 (Sehr einfach)"}
            ])}
            ${createLikertRadioGroup("P3_F2_active_kontrolle", "Wenn Sie an die Bedingung denken, in der Sie die Visualisierung aktiv beeinflussen konnten: Inwieweit hatten Sie das Gefühl, Kontrolle über die Visualisierung zu haben?", [
                {value: "1", label: "1 (Gar keine)"}, {value: "2", label: "2"}, {value: "3", label: "3"}, {value: "4", label: "4 (Neutral)"},
                {value: "5", label: "5"}, {value: "6", label: "6"}, {value: "7", label: "7 (Vollständig)"}
            ])}
        `,
        button_label: "Studie abschließen und Daten speichern"
    };

    // --- ZEITSTRAHL ---
    const timeline = [];
    timeline.push(researcher_input_trial);
    // Phase 1
    timeline.push(phase1_instructions);
    timeline.push(phase1_demographics_experience_trial);
    timeline.push(pre_ssq_fitness_check_trial);
    timeline.push(ssq_pre_trial);
    // Phase 2
    timeline.push(phase2_experiment_instructions);
    // Phase 3
    timeline.push(ssq_post_trial);
    timeline.push(phase3_instructions);
    timeline.push(plausibility_questionnaire_trial); // --- NEW --- Added Plausibility Questionnaire
    timeline.push(phase3_music_feedback_trial);
    timeline.push(goldMsi_instructions_trial_phase3);
    timeline.push(goldMsi_emotions_survey_trial);
    timeline.push(goldMsi_training_survey_trial);
    timeline.push(goldMsi_active_engagement_survey_trial); 
    timeline.push(phase3_additional_music_questions_trial); 
    timeline.push(aims_survey_trial);
    timeline.push(phase3_tech_comfort_trial);
    timeline.push(phase3_active_feedback_trial);

    jsPsych.run(timeline);

</script>
</html>